<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FiFo: Проводник в финансовое благополучие</title>

<!-- PWA Manifest and Theme Color -->
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#0D1117"/>
<link rel="apple-touch-icon" href="/icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root {
    --bg-main: #0D1117;
    --bg-card: #161B22;
    --bg-input: #010409;
    --border-color: #30363D;
    --text-primary: #E6EDF3;
    --text-secondary: #848D97;
    --accent-blue: #2F81F7;
    --accent-green: #238636;
    --accent-red: #DA3633;
    --accent-yellow: #DBAB09;
    --shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
}

* { box-sizing: border-box; }

html, body {
    height: 100%;
    margin: 0;
    scroll-behavior: smooth;
}

body {
    font-family: 'Inter', sans-serif;
    background-color: var(--bg-main);
    color: var(--text-primary);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

.app {
    max-width: 1280px;
    margin: 0 auto;
    padding: 24px;
    display: none; /* Hidden by default */
}

#auth-overlay {
    position: fixed;
    inset: 0;
    background: var(--bg-main);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 24px;
}

.auth-container {
    width: 100%;
    max-width: 400px;
    text-align: center;
}

.auth-container h1 {
    font-size: 32px;
    margin-bottom: 16px;
}

.auth-container p {
    color: var(--text-secondary);
    margin-bottom: 32px;
}

.auth-form {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.auth-form input {
    text-align: center;
}

.auth-form .row {
    justify-content: center;
}

#auth-error {
    color: var(--accent-red);
    min-height: 20px;
    font-size: 14px;
}

.card {
    background-color: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 24px;
    box-shadow: var(--shadow);
    transition: all 0.2s ease-in-out;
}

.card:hover {
    border-color: #464c54;
}

.grid {
    display: grid;
    gap: 24px;
}
.g2 { grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); }
.g3 { grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 24px;
}

.header-title h1 {
    font-size: 28px;
    font-weight: 700;
    margin: 0;
}
.header-title p {
    font-size: 14px;
    color: var(--text-secondary);
    margin: 4px 0 0;
}

.header-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
}

.title {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.subtitle {
    font-size: 14px;
    color: var(--text-secondary);
    margin-top: -4px;
    margin-bottom: 16px;
}


.row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
}

input, select {
    background-color: var(--bg-input);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 14px;
    font-family: 'Inter', sans-serif;
    flex-grow: 1;
    transition: all 0.2s ease-in-out;
}

input:focus, select:focus {
    outline: none;
    border-color: var(--accent-blue);
    box-shadow: 0 0 0 3px rgba(47, 129, 247, 0.3);
}

.btn {
    background-color: #21262D;
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    font-family: inherit;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s ease-in-out;
}

.btn:hover {
    background-color: #30363d;
    border-color: #8b949e;
}

.btn-prim {
    /* Base styles from .btn */
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-family: inherit;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s ease-in-out;
    
    /* Primary-specific styles */
    background-color: var(--accent-green);
    border: 1px solid var(--accent-green);
    color: white;
    font-weight: 600;
}

.btn-prim:hover {
    background-color: #2ea043;
    border-color: #2ea043;
}

.notice {
    padding: 16px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background-color: rgba(1, 4, 9, 0.5);
}

.kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 16px;
}
.kpi-item {
    background-color: var(--bg-main);
    padding: 12px;
    border-radius: 8px;
}
.kpi-item .label {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 4px;
}
.kpi-item .value {
    font-size: 22px;
    font-weight: 700;
}

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}
th, td {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-color);
    text-align: left;
}
th {
    color: var(--text-secondary);
    font-weight: 600;
}
td {
    white-space: nowrap;
}
.table-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

#loading-overlay {
    position: fixed; inset: 0;
    background: rgba(13, 17, 23, 0.95);
    display: flex; align-items: center; justify-content: center;
    z-index: 999;
    flex-direction: column; gap: 16px;
    backdrop-filter: blur(5px);
}
.loader {
    border: 4px solid var(--border-color);
    border-top: 4px solid var(--accent-blue);
    border-radius: 50%;
    width: 48px; height: 48px;
    animation: spin 1s linear infinite;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

.ok { color: #56d364; }
.warn { color: var(--accent-yellow); }
.crit { color: var(--accent-red); }

.file-input-label {
    position: relative;
    overflow: hidden;
    display: inline-block;
}
.file-input-label input[type=file] {
    position: absolute;
    font-size: 100px;
    left: 0;
    top: 0;
    opacity: 0;
    cursor: pointer;
}

.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
}

</style>
</head>
<body>

<!-- =============================================================== -->
<!-- ВАША КОНФИГУРАЦИЯ FIREBASE                                       -->
<!-- Сюда нужно вставить firebaseConfig и appId из вашего проекта      -->
<!-- =============================================================== -->
<script>
    // ШАГ 1: ВСТАВЬТЕ СКОПИРОВАННЫЙ firebaseConfig НИЖЕ
    const firebaseConfig = {
        apiKey: "AIzaSyC6Xpy-5uBAb09twfptyqtPsYtGb6nTLcU",
        authDomain: "fifo-75b02.firebaseapp.com",
        projectId: "fifo-75b02",
        storageBucket: "fifo-75b02.appspot.com",
        messagingSenderId: "636680486355",
        appId: "1:636680486355:web:b5dcac43646294ffe18326",
        measurementId: "G-TT9E4MVQ3D"
    };

    // ШАГ 2: ВСТАВЬТЕ ВАШ APP ID (projectId) НИЖЕ
    const appId = "fifo-75b02";
</script>
<!-- =============================================================== -->
<!-- КОНЕЦ СЕКЦИИ КОНФИГУРАЦИИ                                      -->
<!-- =============================================================== -->

<div id="auth-overlay">
    <div class="auth-container">
        <h1>Добро пожаловать в FiFo</h1>
        <p>проводник в финансовое благополучие</p>
        <div class="auth-form">
            <input type="email" id="auth-email" placeholder="Ваш Email" autocomplete="email">
            <input type="password" id="auth-password" placeholder="Пароль" autocomplete="current-password">
            <div id="auth-error"></div>
            <div class="row">
                <button id="btn-login" class="btn">Войти</button>
                <button id="btn-register" class="btn-prim">Регистрация</button>
            </div>
        </div>
    </div>
</div>

<div id="loading-overlay" style="display: none;">
  <div class="loader"></div>
  <p style="color: var(--text-secondary);">Загрузка данных...</p>
</div>

<div class="app">
  <header class="header">
      <div class="header-title">
          <h1>FiFo</h1>
          <p>Ваш проводник в финансовое благополучие</p>
      </div>
      <div class="header-actions">
          <div style="text-align: right;">
            <div id="user-email" style="font-size: 14px; font-weight: 500;"></div>
            <select id="budget-switcher" class="btn" style="max-width: 200px; margin-top: 4px;" title="Переключиться между бюджетами"></select>
          </div>
          <button id="btn-logout" class="btn" title="Выйти из аккаунта">Выйти</button>
      </div>
  </header>

  <main class="grid" style="gap: 24px;">
    <div class="card">
        <div class="title">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            Семейный режим
        </div>
        <p class="subtitle">Поделитесь ID текущего бюджета с семьей для совместного ведения финансов.
            <span id="sync-status" style="margin-left: 8px; font-weight: 500;"></span>
        </p>
        <div class="row">
            <input id="current-budget-id" type="text" readonly title="ID текущего активного бюджета. Скопируйте и отправьте его членам семьи.">
            <button id="btn-copy-id" class="btn" title="Скопировать ID в буфер обмена">Копировать ID</button>
        </div>
        <div class="row" style="margin-top: 12px;">
            <input id="join-budget-id" type="text" placeholder="Вставьте ID для подключения к бюджету" title="Если член семьи прислал вам ID, вставьте его сюда, чтобы подключиться.">
            <button id="btn-join-budget" class="btn-prim" title="Подключиться к бюджету по ID">Присоединиться</button>
        </div>
    </div>
    
     <div class="card">
        <div class="title">Сводка за месяц</div>
        <p class="subtitle">Ключевые показатели ваших финансов за текущий календарный месяц.</p>
        <div class="kpi-grid">
            <div class="kpi-item">
                <div class="label">Доходы</div>
                <div class="value ok" id="kpi-income">—</div>
            </div>
            <div class="kpi-item">
                <div class="label">Расходы</div>
                <div class="value warn" id="kpi-expense">—</div>
            </div>
            <div class="kpi-item">
                <div class="label">Баланс</div>
                <div class="value" id="kpi-balance">—</div>
            </div>
        </div>
        <div id="kpi-meta" style="font-size: 12px; color: var(--text-secondary); margin-top: 16px; text-align: center;"></div>
    </div>
    
    <div class="card">
        <div class="title">План на месяц</div>
        <p class="subtitle">Установите цели, чтобы отслеживать свой прогресс и не выходить за рамки бюджета.</p>
        <div class="row">
            <input id="plan-income" type="number" step="100" placeholder="План доходов" title="Какую сумму вы планируете получить в этом месяце?"/>
            <input id="plan-expense" type="number" step="100" placeholder="Целевые расходы" title="Больше какой суммы вы стараетесь не тратить?"/>
        </div>
         <div class="row" style="margin-top: 12px;">
            <input id="plan-savings" type="number" step="100" placeholder="Цель по сбережениям" title="Какую сумму вы хотите сберечь в этом месяце?"/>
            <select id="plan-weekly" title="Сколько недель в текущем месяце для расчета недельных лимитов?"><option value="4">4 недели</option><option value="5">5 недель</option></select>
        </div>
        <button id="btn-save-plan" class="btn-prim" style="width: 100%; margin-top: 12px;" title="Сохранить или обновить ваш финансовый план">Сохранить план</button>
    </div>

    <div class="card" style="grid-column: 1 / -1;">
        <div class="title">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            Риски и алерты
        </div>
         <p class="subtitle">Система автоматически анализирует ваши данные и предупреждает о потенциальных проблемах.</p>
        <div id="risk-panel" class="notice">Внесите данные, чтобы увидеть оценку.</div>
    </div>
    
    <div class="card" style="grid-column: 1 / -1;">
        <div class="title">Добавление транзакции</div>
        <p class="subtitle">Зафиксируйте здесь все ваши доходы и расходы для точного учета.</p>
        <div class="grid g3">
            <input id="tx-date" type="date" title="Дата операции"/>
            <select id="tx-type" title="Тип операции: Доход или Расход"><option value="expense">Расход</option><option value="income">Доход</option></select>
            <input id="tx-cat" placeholder="Категория" list="cat-list" title="Например: Продукты, Транспорт, Зарплата"/>
            <input id="tx-amt" type="number" step="10" placeholder="Сумма, ₽" title="Сумма операции в рублях"/>
            <input id="tx-note" placeholder="Комментарий" style="grid-column: span 2;" title="Любая дополнительная информация: магазин, назначение перевода и т.д."/>
        </div>
        <div class="row" style="margin-top: 16px; justify-content: flex-end;">
            <button id="btn-autocat" class="btn" title="Автоматически определить категории для транзакций без категории">Автокатегоризовать</button>
            <button id="btn-add" class="btn-prim" title="Сохранить транзакцию">Добавить транзакцию</button>
        </div>
        <datalist id="cat-list"></datalist>
    </div>

    <div class="card" style="grid-column: 1 / -1;">
        <div class="title">Транзакции</div>
         <p class="subtitle">Полный список всех ваших финансовых операций. Самые свежие — сверху.</p>
        <div class="table-container">
            <table id="tx-table">
                <thead><tr><th>Дата</th><th>Тип</th><th>Категория</th><th style="text-align: right;">Сумма, ₽</th><th>Комментарий</th><th></th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    
    <div class="card">
        <div class="title">Структура расходов</div>
        <p class="subtitle">На что уходят ваши деньги в этом месяце?</p>
        <div class="chart-container">
            <canvas id="pie"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="title">Баланс по месяцам</div>
        <p class="subtitle">Динамика ваших доходов и расходов за последний год.</p>
        <div class="chart-container">
            <canvas id="bar"></canvas>
        </div>
    </div>

    <div class="card" style="grid-column: 1 / -1;">
        <div class="title">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
            Рекомендации помощника
        </div>
        <p class="subtitle">Получите персональные советы по оптимизации бюджета от нашего умного помощника.</p>
        <div id="advice" class="notice">Советы появятся автоматически. Нажмите на кнопку, чтобы получить персональные рекомендации от ИИ.</div>
        <div id="advice-loader" style="display: none; margin-top: 16px; text-align: center;">
            <div class="loader" style="margin: 0 auto;"></div>
            <p style="color: var(--text-secondary); margin-top: 8px;">Анализируем ваши финансы...</p>
        </div>
        <button id="btn-gemini-advice" class="btn-prim" style="width: 100%; margin-top: 16px;" title="Отправить анонимные данные за месяц для получения совета от ИИ">
            ✨ Получить умный совет
        </button>
    </div>
  </main>
</div>

<script type="module">
// Firebase Imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, onSnapshot, setDoc, getDoc, updateDoc, arrayUnion, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// ==== CONFIG & STATE ====
const template={plan:{income:100000,expense:80000,savings:20000,weeks:4}, tx:[], debts:[], goals:[], cats:{}, recur:[]};
let DB = structuredClone(template);
let db, auth, userId, unsubscribe, activeBudgetId;
let userData = { personalBudgetId: null, sharedBudgets: [] };

// ==== DOM ELEMENTS ====
let el = {};

function populateDomElements() {
    el.app = document.querySelector('.app');
    el.authOverlay = document.getElementById('auth-overlay');
    el.loadingOverlay = document.getElementById('loading-overlay');
    el.authEmail = document.getElementById('auth-email');
    el.authPassword = document.getElementById('auth-password');
    el.authError = document.getElementById('auth-error');
    el.btnLogin = document.getElementById('btn-login');
    el.btnRegister = document.getElementById('btn-register');
    el.userEmail = document.getElementById('user-email');
    el.budgetSwitcher = document.getElementById('budget-switcher');
    el.btnLogout = document.getElementById('btn-logout');
    el.syncStatus = document.getElementById('sync-status');
    el.currentBudgetId = document.getElementById('current-budget-id');
    el.btnCopyId = document.getElementById('btn-copy-id');
    el.joinBudgetId = document.getElementById('join-budget-id');
    el.btnJoinBudget = document.getElementById('btn-join-budget');
    el.planIncome = document.getElementById('plan-income');
    el.planExpense = document.getElementById('plan-expense');
    el.planSavings = document.getElementById('plan-savings');
    el.planWeeks = document.getElementById('plan-weekly');
    el.btnSavePlan = document.getElementById('btn-save-plan');
    el.kpiI = document.getElementById('kpi-income');
    el.kpiE = document.getElementById('kpi-expense');
    el.kpiB = document.getElementById('kpi-balance');
    el.kpiMeta = document.getElementById('kpi-meta');
    el.risk = document.getElementById('risk-panel');
    el.txDate = document.getElementById('tx-date');
    el.txType = document.getElementById('tx-type');
    el.txCat = document.getElementById('tx-cat');
    el.txAmt = document.getElementById('tx-amt');
    el.txNote = document.getElementById('tx-note');
    el.btnAdd = document.getElementById('btn-add');
    el.btnAutocat = document.getElementById('btn-autocat');
    el.txTableBody = document.querySelector('#tx-table tbody');
    el.pie = document.getElementById('pie');
    el.bar = document.getElementById('bar');
    el.advice = document.getElementById('advice');
    el.btnGeminiAdvice = document.getElementById('btn-gemini-advice');
    el.adviceLoader = document.getElementById('advice-loader');
    el.catList = document.getElementById('cat-list');
}


// ==== FIREBASE & AUTH ====
async function initializeFirebase() {
    try {
        if (!firebaseConfig || !appId || firebaseConfig.apiKey === "AIzaSy...YOUR_API_KEY") {
            el.authError.textContent = "Ошибка: Конфигурация Firebase не найдена. Укажите ее в HTML-файле.";
            return;
        }
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        setLogLevel('error'); 

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                el.authOverlay.style.display = 'none';
                el.loadingOverlay.style.display = 'flex';
                el.userEmail.textContent = user.email;
                await fetchUserData();
                el.loadingOverlay.style.display = 'none';
                el.app.style.display = 'block';
            } else {
                userId = null;
                el.app.style.display = 'none';
                el.authOverlay.style.display = 'flex';
                el.loadingOverlay.style.display = 'none';
                if(unsubscribe) unsubscribe();
            }
        });
    } catch (error) {
        console.error("Firebase initialization failed:", error);
        el.authError.textContent = "Ошибка инициализации. Попробуйте позже.";
    }
}

async function fetchUserData() {
    const userDocRef = doc(db, `artifacts/${appId}/users/${userId}`);
    const docSnap = await getDoc(userDocRef);

    if (docSnap.exists()) {
        userData = docSnap.data();
        activeBudgetId = userData.personalBudgetId;
        populateBudgetSwitcher();
        await setupRealtimeListener();
    } else {
        console.log("No user data found, creating for new user.");
        // This case handles registration where the user document might not exist yet.
    }
}

function populateBudgetSwitcher() {
    el.budgetSwitcher.innerHTML = '';
    const personalOpt = document.createElement('option');
    personalOpt.value = userData.personalBudgetId;
    personalOpt.textContent = 'Личный бюджет';
    el.budgetSwitcher.appendChild(personalOpt);

    if (userData.sharedBudgets) {
        userData.sharedBudgets.forEach((budgetId, i) => {
            const sharedOpt = document.createElement('option');
            sharedOpt.value = budgetId;
            sharedOpt.textContent = `Общий бюджет ${i + 1}`;
            el.budgetSwitcher.appendChild(sharedOpt);
        });
    }

    el.budgetSwitcher.value = activeBudgetId;
}

// ==== DATA SYNC ====
async function save() {
    if (!userId || !db || !activeBudgetId) return;
    el.syncStatus.textContent = 'Сохранение...';
    try {
        const docRef = doc(db, `artifacts/${appId}/public/data/budgets/${activeBudgetId}`);
        await setDoc(docRef, DB, { merge: true });
        el.syncStatus.textContent = 'Синхронизировано';
    } catch (error) {
        console.error("Error saving data:", error);
        el.syncStatus.textContent = 'Ошибка сохранения';
    }
}

async function setupRealtimeListener() {
    if (unsubscribe) unsubscribe();
    if (!activeBudgetId) return;

    el.currentBudgetId.value = activeBudgetId;
    
    const docRef = doc(db, `artifacts/${appId}/public/data/budgets/${activeBudgetId}`);
    
    unsubscribe = onSnapshot(docRef, (docSnap) => {
        if (docSnap.exists()) {
            const data = docSnap.data();
            Object.keys(template).forEach(key => {
                DB[key] = data[key] || structuredClone(template[key]);
            });
        } else {
            DB = structuredClone(template);
            preload(); 
            save(); 
        }
        recalc();
        el.syncStatus.textContent = 'Синхронизировано';
    }, (error) => {
        console.error("Realtime listener error:", error);
        el.syncStatus.textContent = 'Ошибка подключения';
    });
}

// ==== Utils, Autocat, Renderers (mostly unchanged) ====
const fmt = n => (n===null||n===undefined||isNaN(n)) ? '—' : (+n).toLocaleString('ru-RU');
const todayISO = () => new Date().toISOString().slice(0,10);
const ym = d => {const t=new Date(d); return `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}`;}
const sum = a => a.reduce((x,y)=>x+(+y||0),0);
const groupBy = (a,fn)=>{const m=new Map(); for(const it of a){const k=fn(it); if(!m.has(k)) m.set(k,[]); m.get(k).push(it);} return m;};
const uniq = a => Array.from(new Set(a));
const PRESET=[ {cat:'Продукты', k:['пятерочка','перекресток','перекрёсток','лента','магнит','дикси','вкусвилл','ашан','окей','ярче','globus','lenta','perek','vkusvill'], mcc:[5411,5499]}, {cat:'Кафе/Доставка', k:['яндекс еда','delivery','самокат','лавка','yandex go','dodo','kfc','burger','шаверма','sushi'], mcc:[5812,5814]}, {cat:'Транспорт', k:['метро','мосгортранс','мцд','мцк','тройка','каршер','такси','uber','yandex taxi','citymobil'], mcc:[4111,4789]}, {cat:'Связь/Интернет', k:['мтс','билайн','мегафон','йота','tele2','ростелеком','rtk','интернет'], mcc:[4812,4814]}, {cat:'Жильё/Аренда', k:['аренда','найм','квартира'], mcc:[]}, {cat:'Коммуналка', k:['жкх','жку','мосэнергосбыт','водоканал'], mcc:[]}, {cat:'Здоровье', k:['аптека','rigla','stolichki','клиника','медцентр','анализ','мрт','кт','libre'], mcc:[5912,8011]}, {cat:'Реабилитация', k:['бассейн','лфк','реабил'], mcc:[]}, {cat:'Дети', k:['школа','сад','кружок'], mcc:[]}, {cat:'Подписки', k:['яндекс плюс','yandex plus','netflix','ivi','okko','spotify','apple','google','chatgpt','openai'], mcc:[]}, {cat:'Питомец', k:['зоомаг','zoo','четыре лапы'], mcc:[]}, {cat:'Переводы', k:['сбп','перевод','p2p','transfer'], mcc:[]}, {cat:'Снятие наличных', k:['atm','банкомат','cash'], mcc:[6011]}, {cat:'Прочее', k:[], mcc:[]}];
function guessCategory(note, mcc, channel){ const s=(note||'').toLowerCase(); if(channel && /сбп|sbp/.test(channel.toLowerCase())) return 'Переводы'; if(channel && /atm|банкомат/.test(channel.toLowerCase())) return 'Снятие наличных'; for(const r of PRESET){ if(r.mcc.includes(+mcc)) return r.cat; if(r.k.some(k=>s.includes(k))) return r.cat; } return 'Прочее';}
function recalc(){ const cur=ym(new Date()); const inMonth=DB.tx.filter(t=>ym(t.date)===cur); const inc=sum(inMonth.filter(t=>t.type==='income').map(t=>+t.amount||0)); const exp=sum(inMonth.filter(t=>t.type==='expense').map(t=>+t.amount||0)); const bal=inc-exp; el.kpiI.textContent=fmt(inc); el.kpiE.textContent=fmt(exp); el.kpiB.textContent=fmt(bal); el.planIncome.value=DB.plan.income||''; el.planExpense.value=DB.plan.expense||''; el.planSavings.value=DB.plan.savings||''; el.planWeeks.value=DB.plan.weeks||4; el.kpiMeta.textContent=`План: доход ${fmt(DB.plan.income)} · расход ${fmt(DB.plan.expense)} · сбережения ${fmt(DB.plan.savings)}`; renderRisks(inc,exp,bal); renderTx(); renderCharts(); renderAdvice(inc,exp,bal); refreshCatList();}
function renderRisks(inc,exp,bal){ 
    const notes=[]; 
    if(inc<=0) notes.push({lvl:'crit',text:'В месяце нет доходов.'}); 
    if(DB.plan.expense && exp>DB.plan.expense) notes.push({lvl:'warn',text:`Расходы выше плана на ${fmt(exp-DB.plan.expense)} ₽.`}); 
    if(bal<0) notes.push({lvl:'crit',text:'Отрицательный баланс — урежьте переменные траты.'}); 
    const cur=ym(new Date()); 
    const exps=DB.tx.filter(t=>t.type==='expense' && ym(t.date)===cur); 
    const total=sum(exps.map(t=>+t.amount||0))||1; 
    const opaque=sum(exps.filter(t=>['Снятие наличных','Переводы','Переводы СБП'].includes(t.cat)).map(t=>+t.amount||0))/total; 
    if(opaque>0.25) notes.push({lvl:'warn',text:`Наличные/переводы ${(opaque*100).toFixed(0)}% — цель <15%.`}); 
    el.risk.innerHTML = notes.length? notes.map(n=>`<div class="${n.lvl==='crit'?'crit':'warn'}">• ${n.text}</div>`).join('<br/>') : '<span class="ok">Ок: следуйте плану.</span>';
}
function renderTx(){ const rows=[...DB.tx].sort((a,b)=> new Date(b.date)-new Date(a.date)); el.txTableBody.innerHTML = rows.map((t, idx)=>{ return `<tr data-idx="${idx}"> <td>${t.date||''}</td> <td><span class="${t.type==='income'?'ok':'warn'}">${t.type==='income'?'Доход':'Расход'}</span></td> <td>${t.cat||''}</td> <td style="text-align: right;">${fmt(t.amount)||''}</td> <td>${t.note||''}</td> <td style="text-align: center;"><button class="btn" data-action="del" style="padding: 4px 8px; font-size: 12px;" title="Удалить транзакцию">✕</button></td> </tr>`; }).join('');}
function refreshCatList(){ const cats=uniq(DB.tx.map(t=>t.cat).filter(Boolean).concat(Object.keys(DB.cats))); el.catList.innerHTML = cats.sort().map(c=>`<option value="${c}"></option>`).join('');}
let pieRef, barRef;
function renderCharts(){ const chartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#848D97', font: { family: "'Inter', sans-serif" } } } }, scales: { x: { ticks: { color: '#848D97' }, grid: { color: '#30363D' } }, y: { ticks: { color: '#848D97' }, grid: { color: '#30363D' } } } }; const cur=ym(new Date()); const byCat=groupBy(DB.tx.filter(t=>t.type==='expense' && ym(t.date)===cur), t=>t.cat||'—'); const labels=Array.from(byCat.keys()); const vals=labels.map(k=> sum(byCat.get(k).map(t=>+t.amount||0))); if(pieRef) pieRef.destroy(); try{ pieRef=new Chart(el.pie,{type:'doughnut',data:{labels,datasets:[{data:vals, backgroundColor: ['#2F81F7', '#238636', '#DA3633', '#DBAB09', '#848D97', '#6e7681', '#58a6ff'], borderWidth: 0 }]},options: chartOptions}); }catch(e){ console.error("Pie Chart Error:", e) } const byMon=groupBy(DB.tx, t=>ym(t.date)); const months=Array.from(byMon.keys()).sort().slice(-12); const balances=months.map(m=>{const arr=byMon.get(m); const I=sum(arr.filter(t=>t.type==='income').map(t=>+t.amount||0)); const E=sum(arr.filter(t=>t.type==='expense').map(t=>+t.amount||0)); return I-E;}); if(barRef) barRef.destroy(); try{ barRef=new Chart(el.bar,{type:'bar',data:{labels:months,datasets:[{label:'Баланс',data:balances, backgroundColor: balances.map(b => b >= 0 ? 'rgba(35, 134, 54, 0.6)' : 'rgba(218, 54, 51, 0.6)'), borderColor: balances.map(b => b >= 0 ? '#238636' : '#DA3633'), borderWidth: 1 }]}, options: chartOptions}); }catch(e){ console.error("Bar Chart Error:", e) }}
function renderAdvice(inc,exp,bal){ const adv=[]; if(bal<0) adv.push({t:`Баланс отрицательный (${fmt(bal)} ₽).`,d:`Сократите «Развлечения» и «Кафе/Доставка».`}); if(DB.plan.savings && bal<DB.plan.savings) adv.push({t:`Сбережения ниже цели.`,d:`Увеличьте доход и возьмите ланч из дома.`}); if (el.advice.querySelector('.gemini-advice')) return; el.advice.innerHTML = adv.length? adv.map(x=>`<p><b>${x.t}</b><br><span style="font-size: 12px; color: var(--text-secondary);">${x.d}</span></p>`).join('') : '<p style="color: var(--text-secondary);">Советы появятся после ввода. Нажмите на кнопку, чтобы получить персональные рекомендации от ИИ.</p>';}
async function getGeminiAdvice() { el.btnGeminiAdvice.disabled = true; el.advice.innerHTML = ''; el.adviceLoader.style.display = 'block'; try { const cur = ym(new Date()); const inMonth = DB.tx.filter(t => ym(t.date) === cur); const income = sum(inMonth.filter(t => t.type === 'income').map(t => +t.amount || 0)); const expense = sum(inMonth.filter(t => t.type === 'expense').map(t => +t.amount || 0)); const expensesByCat = groupBy(inMonth.filter(t => t.type === 'expense'), t => t.cat || 'Прочее'); let expensesText = ''; expensesByCat.forEach((txs, cat) => { expensesText += `${cat}: ${fmt(sum(txs.map(t => t.amount)))}, `; }); if (income === 0 && expense === 0) { el.advice.innerHTML = '<p style="color: var(--text-secondary);">Недостаточно данных для анализа.</p>'; return; } const userQuery = `Проанализируй финансы за месяц и дай 2-3 коротких, действенных совета на русском языке. Будь дружелюбным финансовым консультантом. Доход: ${fmt(income)}, Расходы: ${fmt(expense)}, Расходы по категориям: ${expensesText.slice(0, -2) || 'Нет'}, План по сбережениям: ${fmt(DB.plan.savings)}`; const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`; const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: "You are a helpful financial advisor. Your response must be in Russian. Format as a simple markdown list." }] }, }; const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) throw new Error(`API call failed: ${response.status}`); const result = await response.json(); const adviceText = result.candidates?.[0]?.content?.parts?.[0]?.text; if (adviceText) { let htmlAdvice = adviceText.split('\n').filter(line => line.trim().startsWith('*') || line.trim().startsWith('-')).map(line => `<p style="margin-bottom: 8px;">${line.substring(2).trim()}</p>`).join(''); el.advice.innerHTML = `<div class="gemini-advice">${htmlAdvice}</div>`; } else { el.advice.innerHTML = '<p class="crit">Не удалось получить совет. Попробуйте позже.</p>'; } } catch (error) { console.error("Error fetching Gemini advice:", error); el.advice.innerHTML = '<p class="crit">Ошибка при получении совета.</p>'; } finally { el.btnGeminiAdvice.disabled = false; el.adviceLoader.style.display = 'none'; }}

// ==== Events ====
function setupEventListeners() {
    el.btnLogin.onclick = async () => {
        const email = el.authEmail.value;
        const password = el.authPassword.value;
        el.authError.textContent = '';
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            if (error.code === 'auth/operation-not-allowed') {
                el.authError.textContent = 'Ошибка: Вход по Email/Паролю не включен в настройках Firebase.';
            } else {
                el.authError.textContent = 'Ошибка входа. Проверьте данные.';
            }
            console.error("Login error:", error);
        }
    };

    el.btnRegister.onclick = async () => {
        const email = el.authEmail.value;
        const password = el.authPassword.value;
        el.authError.textContent = '';
        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const newUser = userCredential.user;
            
            const newPersonalBudgetId = crypto.randomUUID();
            const userDocRef = doc(db, `artifacts/${appId}/users/${newUser.uid}`);
            await setDoc(userDocRef, {
                email: newUser.email,
                personalBudgetId: newPersonalBudgetId,
                sharedBudgets: []
            });

        } catch (error) {
            if (error.code === 'auth/operation-not-allowed') {
                el.authError.textContent = 'Ошибка: Вход по Email/Паролю не включен в настройках Firebase.';
            } else {
                el.authError.textContent = 'Ошибка регистрации. Пароль не менее 6 символов.';
            }
            console.error("Register error:", error);
        }
    };

    el.btnLogout.onclick = () => {
        signOut(auth);
    };

    el.budgetSwitcher.onchange = () => {
        const newBudgetId = el.budgetSwitcher.value;
        if (newBudgetId !== activeBudgetId) {
            activeBudgetId = newBudgetId;
            el.loadingOverlay.style.display = 'flex';
            setupRealtimeListener();
            setTimeout(() => el.loadingOverlay.style.display = 'none', 500);
        }
    };

    el.btnCopyId.onclick = () => {
        navigator.clipboard.writeText(el.currentBudgetId.value).then(() => alert('ID бюджета скопирован!'));
    };

    el.btnJoinBudget.onclick = async () => {
        const newId = el.joinBudgetId.value.trim();
        if (newId && userData.sharedBudgets && !userData.sharedBudgets.includes(newId) && newId !== userData.personalBudgetId) {
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}`);
            try {
                await updateDoc(userDocRef, {
                    sharedBudgets: arrayUnion(newId)
                });
                el.joinBudgetId.value = '';
                alert('Вы успешно присоединились к бюджету!');
                await fetchUserData(); 
                el.budgetSwitcher.value = newId; 
                el.budgetSwitcher.dispatchEvent(new Event('change'));
            } catch(e) {
                alert('Не удалось присоединиться к бюджету.');
                console.error(e);
            }
        }
    };

    el.btnGeminiAdvice.onclick = getGeminiAdvice;
    el.btnSavePlan.onclick=()=>{ DB.plan.income=+el.planIncome.value||0; DB.plan.expense=+el.planExpense.value||0; DB.plan.savings=+el.planSavings.value||0; DB.plan.weeks=+el.planWeeks.value||4; save(); };
    el.btnAdd.onclick=()=>{ const t={date:el.txDate.value||todayISO(), type:el.txType.value, cat:(el.txCat.value||'').trim()||(el.txType.value==='income'?'Доход':'Прочее'), amount:+el.txAmt.value||0, note:(el.txNote.value||'').trim(), mcc:null, channel:null}; if(!(t.amount>0)){ alert('Введите сумму'); return; } DB.tx.push(t); save(); el.txDate.value=''; el.txCat.value=''; el.txAmt.value=''; el.txNote.value='';};
    el.txTableBody.addEventListener('click',(e)=>{ const b=e.target.closest('button'); if(!b) return; const tr=e.target.closest('tr'); const idx=+tr.dataset.idx; if(b.dataset.action==='del'){ if(confirm('Удалить транзакцию?')){ DB.tx.splice(idx,1); save(); } } });
    el.btnAutocat.onclick=()=>{ let changed = 0; DB.tx.forEach(t => { if(!t.cat || t.cat === 'Прочее') { const newCat = guessCategory(t.note, t.mcc, t.channel); if (newCat !== t.cat) { t.cat = newCat; changed++; } } }); if (changed > 0) { save(); alert(`Автокатегоризация: обновлено ${changed} транзакций.`); } else { alert('Не найдено транзакций для автокатегоризации.'); }};
    
}

function preload(){ const m=todayISO().slice(0,7); DB.tx.push( {date:`${m}-01`,type:'income',cat:'Зарплата',amount:120000,note:'Пример дохода'}, {date:`${m}-02`,type:'expense',cat:'Аренда',amount:45000,note:'Пример расхода'}, {date:`${m}-03`,type:'expense',cat:'Продукты',amount:15000,note:'Пример расхода'} ); DB.cats={'Продукты':{limit:40000,envelope:'equal'},'Аренда':{limit:45000,envelope:'equal'}}; }

// === Initial Load ===
document.addEventListener('DOMContentLoaded', () => {
    populateDomElements();
    initializeFirebase();
    setupEventListeners();

    // Register Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').then(registration => {
                console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }, err => {
                console.log('ServiceWorker registration failed: ', err);
            });
        });
    }
});

</script>
</body>
</html>