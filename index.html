<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FiFo – Финансовый помощник</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0D1117" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root {
      --bg: #0D1117;
      --text: #E6EDF3;
      --text-secondary: #8B949E;
      --accent: #238636;
      --crit: #F85149;
      --fs-h1: clamp(22px, 4.5vw, 28px);
      --fs-h2: clamp(16px, 3.8vw, 20px);
      --fs-text: clamp(13px, 3.4vw, 14px);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: var(--fs-text);
    }
    .app { padding: clamp(12px, 3vw, 24px); max-width: 960px; margin: auto; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
    .header-title h1 { font-size: var(--fs-h1); margin: 0 0 8px 0; }
    .header-actions { display: flex; flex-wrap: wrap; gap: 8px; }
    .btn, .btn-prim {
      background: #161B22;
      border: 1px solid var(--text-secondary);
      color: var(--text);
      border-radius: 6px;
      padding: 10px 14px;
      cursor: pointer;
    }
    .btn-prim { background: var(--accent); border: none; color: #fff; }
    input, select {
      width: 100%;
      padding: 10px 14px;
      border-radius: 6px;
      border: 1px solid #30363D;
      background: #161B22;
      color: var(--text);
    }
    .chart-container { height: 280px; margin: 24px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { padding: 8px; border-bottom: 1px solid #30363D; text-align: left; }
    .crit { color: var(--crit); }
    @media (max-width: 480px) {
      .header { flex-direction: column; align-items: stretch; }
      .header-actions { width: 100%; gap: 8px; }
      .btn, .btn-prim, input, select { width: 100%; }
      th:nth-child(5), td:nth-child(5) { display: none; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="header-title">
        <h1>FiFo</h1>
        <p style="color:var(--text-secondary)">Ваш финансовый помощник</p>
      </div>
      <div class="header-actions">
        <button class="btn-prim" id="btnAddTx">Добавить операцию</button>
        <button class="btn" id="btnAdvice">Совет от Perplexity</button>
      </div>
    </div>

    <div id="summary"></div>
    <div class="chart-container">
      <canvas id="chart"></canvas>
    </div>

    <div id="adviceBox" style="margin-top:20px;">
      <div id="adviceLoader" style="display:none;">⏳ Получаем советы...</div>
      <div id="advice"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      });
    }

    // === Утилиты ===
    const fmt = n => n.toLocaleString('ru-RU');
    const sum = arr => arr.reduce((a, b) => a + b, 0);
    const ym = d => new Date(d).toISOString().slice(0,7);

    // === Данные ===
    const DB = { tx: [], plan: { savings: 0 } };

    // === Пример графика ===
    const ctx = document.getElementById('chart');
    const chart = new Chart(ctx, {
      type: 'bar',
      data: { labels: [], datasets: [{ label: 'Расходы', data: [] }] },
      options: { responsive: true, maintainAspectRatio: false, scales:{y:{beginAtZero:true}} }
    });

    // === Переписанный помощник на Perplexity ===
    const el = {
      btnAdvice: document.getElementById('btnAdvice'),
      advice: document.getElementById('advice'),
      adviceLoader: document.getElementById('adviceLoader')
    };

    async function getPPLXAdvice() {
      el.btnAdvice.disabled = true;
      el.advice.innerHTML = '';
      el.adviceLoader.style.display = 'block';
      try {
        const cur = ym(new Date());
        const inMonth = DB.tx.filter(t => ym(t.date) === cur);
        const income = sum(inMonth.filter(t => t.type === 'income').map(t => +t.amount || 0));
        const expense = sum(inMonth.filter(t => t.type === 'expense').map(t => +t.amount || 0));
        const grouped = {};
        inMonth.filter(t=>t.type==='expense').forEach(t=>{
          grouped[t.cat] = (grouped[t.cat]||0) + (+t.amount||0);
        });
        let categories = Object.entries(grouped).map(([c,v])=>`${c}: ${fmt(v)}`).join(', ');
        if (!categories) categories = 'Нет данных';
        const query = `Проанализируй мои финансы и дай 3 коротких совета на русском.
Доход: ${fmt(income)}, Расходы: ${fmt(expense)}, По категориям: ${categories}.`;

        const res = await fetch('https://sweet-mountain-1ef8.epiwh7.workers.dev', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt: query })
        });
        const data = await res.json();
        const text = data.text || 'Нет ответа.';
        el.advice.innerHTML = text
          .split('\n')
          .filter(Boolean)
          .map(line => `<p>${line.replace(/^[-*]\s?/, '')}</p>`)
          .join('');
      } catch (e) {
        el.advice.innerHTML = '<p class="crit">Ошибка при обращении к Perplexity.</p>';
      } finally {
        el.btnAdvice.disabled = false;
        el.adviceLoader.style.display = 'none';
      }
    }

    el.btnAdvice.onclick = getPPLXAdvice;
  </script>
</body>
</html>