<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>FiFo — Проводник в финансовое благополучие</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0D1117"/>
  <link rel="apple-touch-icon" href="./icons/icon-192.png">

  <!-- Fonts & Charts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0D1117; --card:#161B22; --input:#0b1220; --border:#2a313a;
      --text:#E6EDF3; --muted:#8B949E;
      --blue:#2F81F7; --green:#238636; --red:#DA3633; --yellow:#DBAB09;
      --shadow:0 8px 24px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    .app{max-width:1200px;margin:0 auto;padding:20px;display:none}

    /* Карточки, сетки, хедер */
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px 18px 20px;box-shadow:var(--shadow)}
    .grid{display:grid;gap:18px}
    .g2{grid-template-columns:repeat(auto-fit,minmax(360px,1fr))}
    .g3{grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}
    .header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;padding-bottom:12px;border-bottom:1px solid var(--border);margin-bottom:16px}
    .header h1{margin:0;font-size:clamp(22px,3.2vw,30px);font-weight:800}
    .header p{margin:4px 0 0;color:var(--muted);font-size:14px}
    .header-actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    /* Формы */
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select{width:100%;background:var(--input);border:1px solid var(--border);color:var(--text);padding:12px 14px;border-radius:10px;font-size:16px}
    input:focus,select:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 3px rgba(47,129,247,.25)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}

    /* Кнопки */
    .btn{background:#21262D;border:1px solid var(--border);color:var(--text);padding:12px 14px;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer}
    .btn:hover{background:#2a3037}
    .btn-prim{background:var(--green);border:1px solid var(--green);color:#fff}

    /* KPI/таблица/графики */
    .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px}
    .kpi-item{background:#0f1520;border:1px solid var(--border);border-radius:10px;padding:12px}
    .kpi-item .label{font-size:12px;color:var(--muted)}
    .kpi-item .value{font-size:22px;font-weight:800}
    .table-container{overflow-x:auto;-webkit-overflow-scrolling:touch;border:1px solid var(--border);border-radius:10px}
    table{width:100%;border-collapse:collapse;font-size:15px}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left;white-space:nowrap}
    th{color:var(--muted);font-weight:700}
    .chart-container{position:relative;height:340px;width:100%}
    .chart-container canvas{display:block !important;width:100% !important;height:100% !important}

    /* Оверлеи */
    #auth-overlay{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px}
    .auth-container{width:100%;max-width:460px}
    .auth-title{margin:0 0 6px;font-size:26px;font-weight:800}
    .auth-sub{color:var(--muted);margin:0 0 16px}
    #auth-error{min-height:18px;color:var(--red);font-size:14px}
    #loading-overlay{position:fixed;inset:0;background:rgba(13,17,23,.94);display:none;align-items:center;justify-content:center;z-index:999;flex-direction:column;gap:10px;backdrop-filter:blur(4px)}
    .loader{border:4px solid var(--border);border-top:4px solid var(--blue);border-radius:50%;width:44px;height:44px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .ok{color:#56d364}.warn{color:var(--yellow)}.crit{color:var(--red)}
    .notice{padding:12px;border:1px solid var(--border);border-radius:10px;background:#0b1320}

    /* Мобильный адаптив */
    @media (max-width:480px){
      .app{padding:14px}
      .grid.g2,.grid.g3{grid-template-columns:1fr}
      .header-actions{width:100%}
      .header-actions .btn{width:100%}
      th:nth-child(5),td:nth-child(5){display:none} /* скрываем длинный комментарий */
    }
  </style>
</head>
<body>

<!-- Firebase config -->
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyC6Xpy-5uBAb09twfptyqtPsYtGb6nTLcU",
    authDomain: "fifo-75b02.firebaseapp.com",
    projectId: "fifo-75b02",
    storageBucket: "fifo-75b02.appspot.com",
    messagingSenderId: "636680486355",
    appId: "1:636680486355:web:b5dcac43646294ffe18326",
    measurementId: "G-TT9E4MVQ3D"
  };
  const appId = "fifo-75b02";
</script>

<!-- Авторизация -->
<div id="auth-overlay">
  <div class="auth-container card">
    <h1 class="auth-title">Вход в FiFo</h1>
    <p class="auth-sub">Email и пароль (можно быстро зарегистрироваться).</p>
    <div class="grid g2">
      <div><label for="auth-email">Email</label><input type="email" id="auth-email" placeholder="you@example.com" autocomplete="email"></div>
      <div><label for="auth-password">Пароль</label><input type="password" id="auth-password" placeholder="••••••••" autocomplete="current-password"></div>
    </div>
    <div id="auth-error"></div>
    <div class="row" style="margin-top:12px">
      <button id="btn-login" class="btn">Войти</button>
      <button id="btn-register" class="btn-prim">Регистрация</button>
    </div>
  </div>
</div>

<!-- Лоадер -->
<div id="loading-overlay">
  <div class="loader"></div>
  <div style="color:var(--muted)">Синхронизация данных…</div>
</div>

<!-- Приложение -->
<div class="app">
  <header class="header">
    <div>
      <h1>FiFo</h1>
      <p>Проводник в финансовое благополучие</p>
    </div>
    <div class="header-actions">
      <div style="text-align:right">
        <div id="user-email" style="font-size:14px;font-weight:600"></div>
        <select id="budget-switcher" class="btn" style="max-width:220px;margin-top:6px" title="Выберите бюджет"></select>
      </div>
      <button id="btn-logout" class="btn">Выйти</button>
    </div>
  </header>

  <main class="grid" style="gap:18px">
    <div class="card">
      <div class="title" style="font-weight:800;margin-bottom:8px">Семейный режим</div>
      <p class="notice" id="sync-status" style="margin:0 0 10px;color:var(--muted)">Синхронизация…</p>
      <div class="row">
        <div style="flex:1">
          <label for="current-budget-id">ID текущего бюджета</label>
          <input id="current-budget-id" type="text" readonly>
        </div>
        <button id="btn-copy-id" class="btn">Копировать ID</button>
      </div>
      <div class="row" style="margin-top:10px">
        <div style="flex:1">
          <label for="join-budget-id">Подключиться к бюджету по ID</label>
          <input id="join-budget-id" type="text" placeholder="Вставьте полученный ID">
        </div>
        <button id="btn-join-budget" class="btn-prim">Присоединиться</button>
      </div>
    </div>

    <div class="card">
      <div class="title" style="font-weight:800;margin-bottom:8px">Сводка за месяц</div>
      <div class="kpi-grid">
        <div class="kpi-item"><div class="label">Доходы</div><div class="value ok" id="kpi-income">—</div></div>
        <div class="kpi-item"><div class="label">Расходы</div><div class="value warn" id="kpi-expense">—</div></div>
        <div class="kpi-item"><div class="label">Баланс</div><div class="value" id="kpi-balance">—</div></div>
      </div>
      <div id="kpi-meta" style="font-size:12px;color:var(--muted);margin-top:10px;text-align:center"></div>
    </div>

    <div class="card">
      <div class="title" style="font-weight:800;margin-bottom:8px">План на месяц</div>
      <div class="grid g2">
        <div><label for="plan-income">План доходов</label><input id="plan-income" type="number" step="100" placeholder="напр. 120000"/></div>
        <div><label for="plan-expense">Целевые расходы</label><input id="plan-expense" type="number" step="100" placeholder="напр. 90000"/></div>
        <div><label for="plan-savings">Цель по сбережениям</label><input id="plan-savings" type="number" step="100" placeholder="напр. 30000"/></div>
        <div><label for="plan-weekly">Недель в месяце</label><select id="plan-weekly"><option value="4">4</option><option value="5">5</option></select></div>
      </div>
      <button id="btn-save-plan" class="btn-prim" style="width:100%;margin-top:10px">Сохранить план</button>
    </div>

    <div class="card" style="grid-column:1/-1">
      <div class="title" style="font-weight:800;margin-bottom:8px">Добавление транзакции</div>
      <div class="grid g3">
        <div><label for="tx-date">Дата</label><input id="tx-date" type="date"/></div>
        <div><label for="tx-type">Тип</label><select id="tx-type"><option value="expense">Расход</option><option value="income">Доход</option></select></div>
        <div><label for="tx-cat">Категория</label><input id="tx-cat" placeholder="Напр.: Продукты" list="cat-list"/></div>
        <div><label for="tx-amt">Сумма, ₽</label><input id="tx-amt" type="number" step="10" placeholder="0"/></div>
        <div style="grid-column:span 2"><label for="tx-note">Комментарий</label><input id="tx-note" placeholder="Магазин, назначение…"/></div>
      </div>
      <div class="row" style="margin-top:12px;justify-content:flex-end">
        <button id="btn-autocat" class="btn">Автокатегоризовать</button>
        <button id="btn-add" class="btn-prim">Добавить транзакцию</button>
      </div>
      <datalist id="cat-list"></datalist>
    </div>

    <div class="card" style="grid-column:1/-1">
      <div class="title" style="font-weight:800;margin-bottom:8px">Транзакции</div>
      <div class="table-container">
        <table id="tx-table"><thead>
          <tr><th>Дата</th><th>Тип</th><th>Категория</th><th style="text-align:right">Сумма, ₽</th><th>Комментарий</th><th></th></tr>
        </thead><tbody></tbody></table>
      </div>
    </div>

    <div class="card">
      <div class="title" style="font-weight:800;margin-bottom:8px">Структура расходов</div>
      <div class="chart-container"><canvas id="pie"></canvas></div>
    </div>

    <div class="card">
      <div class="title" style="font-weight:800;margin-bottom:8px">Баланс по месяцам</div>
      <div class="chart-container"><canvas id="bar"></canvas></div>
    </div>

    <div class="card" style="grid-column:1/-1">
      <div class="title" style="font-weight:800;margin-bottom:8px">Рекомендации помощника</div>
      <div id="advice" class="notice">Добавьте пару транзакций и нажмите кнопку — советы появятся здесь.</div>
      <div id="advice-loader" style="display:none;margin-top:10px;text-align:center">
        <div class="loader" style="margin:0 auto"></div>
        <div style="color:var(--muted);margin-top:6px">Анализируем ваши финансы…</div>
      </div>
      <button id="btn-gemini-advice" class="btn-prim" style="width:100%;margin-top:10px">✨ Совет от Perplexity</button>
    </div>
  </main>
</div>

<!-- Регистрация SW -->
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js?v=5').catch(console.error);
  }
</script>

<!-- Логика приложения -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // ---------- State ----------
  const template = { plan:{income:0,expense:0,savings:0,weeks:4}, tx:[], debts:[], goals:[], cats:{}, recur:[] };
  window.DB = structuredClone(template); // делаю доступным для Perplexity блока
  let db, auth, userId, unsubscribe, activeBudgetId;
  let userData = { personalBudgetId:null, sharedBudgets:[] };

  // ---------- DOM ----------
  const $ = id => document.getElementById(id);
  const el = {
    app:document.querySelector('.app'), authOverlay:$('auth-overlay'), loading:$('loading-overlay'),
    authEmail:$('auth-email'), authPass:$('auth-password'), authErr:$('auth-error'),
    btnLogin:$('btn-login'), btnRegister:$('btn-register'), btnLogout:$('btn-logout'),
    userEmail:$('user-email'), budgetSwitcher:$('budget-switcher'), syncStatus:$('sync-status'),
    currentBudgetId:$('current-budget-id'), btnCopyId:$('btn-copy-id'), joinBudgetId:$('join-budget-id'), btnJoinBudget:$('btn-join-budget'),
    planIncome:$('plan-income'), planExpense:$('plan-expense'), planSavings:$('plan-savings'), planWeeks:$('plan-weekly'), btnSavePlan:$('btn-save-plan'),
    kpiI:$('kpi-income'), kpiE:$('kpi-expense'), kpiB:$('kpi-balance'), kpiMeta:$('kpi-meta'),
    txDate:$('tx-date'), txType:$('tx-type'), txCat:$('tx-cat'), txAmt:$('tx-amt'), txNote:$('tx-note'),
    btnAdd:$('btn-add'), btnAutocat:$('btn-autocat'),
    txTableBody:document.querySelector('#tx-table tbody'), catList:$('cat-list'),
    pie:$('pie'), bar:$('bar'),
    advice:$('advice'), adviceLoader:$('advice-loader'), btnAdvice:$('btn-gemini-advice')
  };

  // ---------- Utils ----------
  const fmt = n => (n===null||n===undefined||isNaN(n)) ? '—' : (+n).toLocaleString('ru-RU');
  const todayISO = ()=>{ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); };
  const ym = d => { const t=new Date(d); return `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}`; };
  const sum = a => a.reduce((x,y)=>x+(+y||0),0);
  const uniq = a => Array.from(new Set(a));

  // ---------- Local fallbacks ----------
  const storeKey = uid => `fifo-db-${uid||'guest'}`;
  const saveLocal = () => { try{ localStorage.setItem(storeKey(userId), JSON.stringify(window.DB)); }catch{} };
  const loadLocal = () => { try{ const s=localStorage.getItem(storeKey(userId)); if(s) window.DB=Object.assign(structuredClone(template), JSON.parse(s)); }catch{} };

  // ---------- Charts ----------
  let pieRef, barRef;
  function ensureCharts(){
    if (el.pie && !pieRef){
      pieRef = new Chart(el.pie,{type:'doughnut',data:{labels:[],datasets:[{data:[],backgroundColor:['#2F81F7','#238636','#DA3633','#DBAB09','#6e7681','#58a6ff','#7ee787'],borderWidth:0}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:'#8B949E'}}}}});
    }
    if (el.bar && !barRef){
      barRef = new Chart(el.bar,{type:'bar',data:{labels:[],datasets:[{label:'Баланс',data:[]}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#8B949E'}}},
          scales:{x:{ticks:{color:'#8B949E'},grid:{color:'#2a313a'}},y:{beginAtZero:true,ticks:{color:'#8B949E'},grid:{color:'#2a313a'}}}}});
    }
  }
  function renderCharts(){
    ensureCharts();
    const cur = ym(new Date());
    const monthExpenses = window.DB.tx.filter(t=>t.type==='expense' && ym(t.date)===cur);
    const byCat = {};
    for(const t of monthExpenses) byCat[t.cat||'Прочее'] = (byCat[t.cat||'Прочее']||0)+(+t.amount||0);
    const labels = Object.keys(byCat); const vals = labels.map(k=>byCat[k]);
    if (pieRef){ pieRef.data.labels = labels; pieRef.data.datasets[0].data = vals; pieRef.update(); }

    const byMon = {};
    for(const t of window.DB.tx){ const m=ym(t.date); byMon[m]=byMon[m]||{i:0,e:0}; if(t.type==='income') byMon[m].i+=(+t.amount||0); else byMon[m].e+=(+t.amount||0); }
    const months = Object.keys(byMon).sort().slice(-12);
    const balances = months.map(m=> byMon[m].i - byMon[m].e );
    if (barRef){ barRef.data.labels = months; barRef.data.datasets[0].data = balances; barRef.update(); }
  }

  // ---------- Renderers ----------
  function refreshCatList(){
    const set = new Set((window.DB.tx||[]).map(t=>t.cat).filter(Boolean).concat(Object.keys(window.DB.cats||{})));
    el.catList.innerHTML = Array.from(set).sort().map(c=>`<option value="${c}"></option>`).join('');
  }
  function renderTx(){
    const rows = [...(window.DB.tx||[])].sort((a,b)=> new Date(b.date)-new Date(a.date));
    el.txTableBody.innerHTML = rows.map(t=>`
      <tr>
        <td>${t.date||''}</td>
        <td><span class="${t.type==='income'?'ok':'warn'}">${t.type==='income'?'Доход':'Расход'}</span></td>
        <td>${t.cat||''}</td>
        <td style="text-align:right">${fmt(t.amount)}</td>
        <td>${(t.note||'').replace(/</g,'&lt;')}</td>
        <td style="text-align:center"><button class="btn" data-id="${t.id||''}" data-action="del" style="padding:4px 8px;font-size:12px">✕</button></td>
      </tr>
    `).join('');
  }
  function renderSummary(){
    const cur = ym(new Date());
    const inMonth = window.DB.tx.filter(t=>ym(t.date)===cur);
    const inc = sum(inMonth.filter(t=>t.type==='income').map(t=>+t.amount||0));
    const exp = sum(inMonth.filter(t=>t.type==='expense').map(t=>+t.amount||0));
    const bal = inc-exp;
    el.kpiI.textContent = fmt(inc);
    el.kpiE.textContent = fmt(exp);
    el.kpiB.textContent = fmt(bal);
    el.kpiMeta.textContent = `План: доход ${fmt(window.DB.plan.income)} · расход ${fmt(window.DB.plan.expense)} · сбережения ${fmt(window.DB.plan.savings)}`;
  }
  function render(){
    if (el.txDate && !el.txDate.value) el.txDate.value = todayISO();
    renderSummary(); renderTx(); refreshCatList(); renderCharts();
  }

  // ---------- Firebase ----------
  const app = initializeApp(firebaseConfig);
  db = getFirestore(app);
  auth = getAuth(app);

  const mapErr = (c,m)=>({
    'auth/invalid-credential':'Неверный email или пароль.',
    'auth/user-not-found':'Пользователь не найден.',
    'auth/wrong-password':'Неверный пароль.',
    'auth/too-many-requests':'Слишком много попыток. Подождите.',
    'auth/network-request-failed':'Проблема с сетью или CORS.',
    'auth/invalid-email':'Некорректный email.',
    'auth/operation-not-allowed':'Метод входа отключён в Firebase.',
    'auth/email-already-in-use':'Email уже зарегистрирован.',
    'auth/weak-password':'Слабый пароль (мин. 6 символов).'
  }[c] || m || 'Неизвестная ошибка.');

  el.btnLogin?.addEventListener('click', async ()=>{
    el.authErr.textContent='';
    try{ await signInWithEmailAndPassword(auth, el.authEmail.value.trim(), el.authPass.value.trim()); }
    catch(e){ el.authErr.textContent = mapErr(e.code,e.message); }
  });
  el.btnRegister?.addEventListener('click', async ()=>{
    el.authErr.textContent='';
    try{ await createUserWithEmailAndPassword(auth, el.authEmail.value.trim(), el.authPass.value.trim()); }
    catch(e){ el.authErr.textContent = mapErr(e.code,e.message); }
  });
  el.btnLogout?.addEventListener('click', ()=> signOut(auth));

  onAuthStateChanged(auth, async (user)=>{
    if (user){
      userId = user.uid;
      el.userEmail.textContent = user.email||'';
      el.authOverlay.style.display='none';
      el.loading.style.display='flex';
      await bootstrapUser();
      el.loading.style.display='none';
      el.app.style.display='block';
      render();
    } else {
      userId = null;
      if (unsubscribe) unsubscribe();
      loadLocal();
      el.app.style.display='none';
      el.authOverlay.style.display='flex';
      el.loading.style.display='none';
    }
  });

  async function bootstrapUser(){
    const uref = doc(db, `artifacts/${appId}/users/${userId}`);
    const usnap = await getDoc(uref);
    if (usnap.exists()){
      userData = Object.assign({ personalBudgetId:`${userId}-default`, sharedBudgets:[] }, usnap.data());
    } else {
      userData = { personalBudgetId:`${userId}-default`, sharedBudgets:[] };
      await setDoc(uref, userData, {merge:true});
    }
    activeBudgetId = userData.personalBudgetId;

    el.budgetSwitcher.innerHTML='';
    const opt1 = document.createElement('option'); opt1.value=userData.personalBudgetId; opt1.textContent='Личный бюджет'; el.budgetSwitcher.appendChild(opt1);
    (userData.sharedBudgets||[]).forEach((bid,i)=>{ const o=document.createElement('option'); o.value=bid; o.textContent=`Общий бюджет ${i+1}`; el.budgetSwitcher.appendChild(o); });
    el.budgetSwitcher.value = activeBudgetId;

    await bindBudgetRealtime();
  }

  async function bindBudgetRealtime(){
    if (unsubscribe) unsubscribe();
    el.currentBudgetId.value = activeBudgetId||'';
    el.syncStatus.textContent='Синхронизация…';
    try{
      const bref = doc(db, `artifacts/${appId}/public/data/budgets/${activeBudgetId}`);
      unsubscribe = onSnapshot(bref, (snap)=>{
        if (snap.exists()){
          const data = snap.data() || {};
          window.DB = structuredClone(template);
          for (const k of Object.keys(template)) window.DB[k] = data[k] ?? structuredClone(template[k]);
          saveLocal();
        } else {
          window.DB = structuredClone(template);
          setDoc(bref, window.DB, {merge:true}).catch(()=>{});
          saveLocal();
        }
        el.syncStatus.textContent='Синхронизировано';
        render();
      }, (err)=>{
        console.warn('Firestore offline:', err);
        loadLocal();
        el.syncStatus.textContent='Оффлайн (локальные данные)';
        render();
      });
    } catch(e){
      console.warn('Bind error:', e);
      loadLocal();
      el.syncStatus.textContent='Оффлайн (локальные данные)';
      render();
    }
  }

  async function save(){
    saveLocal();
    try{
      const bref = doc(db, `artifacts/${appId}/public/data/budgets/${activeBudgetId}`);
      await setDoc(bref, window.DB, {merge:true});
      el.syncStatus.textContent='Синхронизировано';
    }catch(e){
      console.warn('Save failed:', e);
      el.syncStatus.textContent='Оффлайн (сохранено локально)';
    }
  }

  // ---------- Interactions ----------
  el.budgetSwitcher?.addEventListener('change', async (e)=>{
    activeBudgetId = e.target.value;
    await bindBudgetRealtime();
  });

  el.btnCopyId?.addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(el.currentBudgetId.value||''); el.syncStatus.textContent='ID скопирован'; }
    catch{ el.syncStatus.textContent='Не удалось скопировать'; }
  });

  el.btnJoinBudget?.addEventListener('click', async ()=>{
    const id = (el.joinBudgetId.value||'').trim();
    if (!id) return;
    userData.sharedBudgets = Array.from(new Set([...(userData.sharedBudgets||[]), id]));
    await setDoc(doc(db, `artifacts/${appId}/users/${userId}`), userData, {merge:true});
    el.joinBudgetId.value='';
    el.budgetSwitcher.innerHTML='';
    const opt1=document.createElement('option'); opt1.value=userData.personalBudgetId; opt1.textContent='Личный бюджет'; el.budgetSwitcher.appendChild(opt1);
    (userData.sharedBudgets||[]).forEach((bid,i)=>{ const o=document.createElement('option'); o.value=bid; o.textContent=`Общий бюджет ${i+1}`; el.budgetSwitcher.appendChild(o); });
    el.budgetSwitcher.value = id;
    activeBudgetId = id;
    await bindBudgetRealtime();
  });

  el.btnSavePlan?.addEventListener('click', async ()=>{
    window.DB.plan.income = +el.planIncome.value||0;
    window.DB.plan.expense = +el.planExpense.value||0;
    window.DB.plan.savings = +el.planSavings.value||0;
    window.DB.plan.weeks = +el.planWeeks.value||4;
    await save(); render();
  });

  document.addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('button[data-action="del"]');
    if (!btn) return;
    const id = btn.getAttribute('data-id');
    if (!id) return;
    window.DB.tx = (window.DB.tx||[]).filter(t=>t.id!==id);
    await save(); render();
  });

  const defaultDate = todayISO(); if (el.txDate && !el.txDate.value) el.txDate.value = defaultDate;
  el.btnAdd?.addEventListener('click', async ()=>{
    const d = el.txDate.value; const type = el.txType.value||'expense';
    const cat=(el.txCat.value||'Прочее').trim(); const amt=+el.txAmt.value||0; const note=(el.txNote.value||'').trim();
    if (!d) return alert('Выберите дату');
    if (!amt || amt<=0) return alert('Сумма должна быть больше 0');
    const tx = { id: crypto.randomUUID?.()||String(Date.now()), date:d, type, cat, amount:amt, note };
    window.DB.tx.unshift(tx);
    await save(); render();
    el.txCat.value=''; el.txAmt.value=''; el.txNote.value='';
  });

  el.btnAutocat?.addEventListener('click', ()=>{
    const PRESET=[
      {cat:'Продукты',k:['пятер','перекрест','лента','магнит','вкусвилл','ашан','окей','lenta','vkus','perek']},
      {cat:'Кафе/Доставка',k:['яндекс еда','delivery','самокат','лавка','kfc','burger','dodo','sushi']},
      {cat:'Транспорт',k:['метро','мцд','мцк','такси','uber','yandex taxi','citymobil']},
      {cat:'Связь/Интернет',k:['мтс','билайн','мегафон','йота','tele2','ростелеком','rtk']},
      {cat:'Здоровье',k:['аптека','rigla','столичк','клиник','анализ']},
      {cat:'Подписки',k:['яндекс плюс','netflix','ivi','okko','spotify','apple','google']},
      {cat:'Переводы',k:['сбп','перевод','p2p']},
      {cat:'Снятие наличных',k:['atm','банкомат']},
      {cat:'Прочее',k:[]}
    ];
    const pick = note=>{
      const s=(note||'').toLowerCase();
      for(const r of PRESET) if(r.k.some(k=>s.includes(k))) return r.cat;
      return 'Прочее';
    };
    (window.DB.tx||[]).forEach(t=>{ if(!t.cat) t.cat = pick(t.note); });
    save(); render();
  });

  // ---------- Perplexity через твой Worker ----------
  const PPLX_ENDPOINT = 'https://sweet-mountain-1ef8.epiwh7.workers.dev'; // твой Cloudflare Worker

  window.getGeminiAdvice = async function(){
    const btn = el.btnAdvice, box = el.advice, loader = el.adviceLoader;
    btn.disabled = true; box.innerHTML=''; loader.style.display='block';
    try{
      const now = new Date();
      const curMonth = ym(now);
      const last60 = new Date(now.getTime()-60*864e5);

      const tx = (window.DB.tx||[]);
      let scope = tx.filter(t=>{ const d=new Date(t.date); return ym(d)===curMonth || d>=last60; });
      const income = sum(scope.filter(t=>t.type==='income').map(t=>+t.amount||0));
      const expense = sum(scope.filter(t=>t.type==='expense').map(t=>+t.amount||0));
      const byCat = {};
      scope.filter(t=>t.type==='expense').forEach(t=>{
        byCat[t.cat||'Прочее'] = (byCat[t.cat||'Прочее']||0)+(+t.amount||0);
      });
      const cats = Object.keys(byCat).map(k=>`${k}: ${(+byCat[k]||0).toLocaleString('ru-RU')} ₽`).join(', ') || 'нет данных';

      const prompt = `Проанализируй мои финансы и дай 3 конкретных совета на русском.
Если транзакций мало — всё равно дай рекомендации, опираясь на цели.
Доход: ${fmt(income)}, Расходы: ${fmt(expense)}, Категории: ${cats}.
Цели: доход ${fmt(window.DB.plan.income)}, расход ${fmt(window.DB.plan.expense)}, сбережения ${fmt(window.DB.plan.savings)}.
Коротко, списком, без воды.`;

      const res = await fetch(PPLX_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt})});
      const textRaw = await res.text();
      let text = '';
      try{ const j=JSON.parse(textRaw); text = j.text || ''; } catch{ text = textRaw; }

      if (!res.ok){
        box.innerHTML = `<p class="crit">Ошибка сервера (${res.status}).</p><pre style="white-space:pre-wrap">${(text||'').slice(0,800)}</pre>`;
        return;
      }
      if (String(text).trim().startsWith('<')){
        box.innerHTML = `<p class="crit">Ответ не JSON (скорее всего HTML-страница ошибки Worker).</p><pre style="white-space:pre-wrap">${text.slice(0,800)}</pre>`;
        return;
      }

      box.innerHTML = text.split('\n').filter(Boolean).map(l=>`<p style="margin:.3rem 0">${l.replace(/^[-*]\s?/, '')}</p>`).join('') || '<p class="crit">Пустой ответ.</p>';
    }catch(e){
      box.innerHTML = `<p class="crit">Ошибка: ${e.message}</p>`;
    }finally{
      btn.disabled=false; loader.style.display='none';
    }
  };
  el.btnAdvice?.addEventListener('click', window.getGeminiAdvice);
</script>

</body>
</html>